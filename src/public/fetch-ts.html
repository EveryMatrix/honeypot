<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>fetching ts2</title>
    <script
            src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>
</head>
<body>
<h1>Fetching ts2 data</h1>
<pre id="response"></pre>
<h2>Log here:</h2>
<pre id="log"></pre>
<script>
    var logstr = [];

    function getLogChain() {
        var chain = [];
        logstr.push(chain);
        return function (m, l) {
            chain.push({message: m, log: l});
            document.getElementById("log").innerHTML = JSON.stringify(logstr, false, 4);
        }
    }

    function log(m, l) {
        logstr.push({message: m, log: l});
        document.getElementById("log").innerHTML = JSON.stringify(logstr, false, 4);

    }

    if (window) {
        window.addEventListener("error", function (e) {
            log("window error", {
                message: e.message,
                stack: e.error.stack,
                timestamp: parseInt(e.timeStamp, 10)
            });
        });
    }

    function doRequest(message, url) {
        var chainLog = getLogChain();
        chainLog("start: " + message, {url: url});

        fetch(url).then(function success(r) {
            if (r.ok) {
                return r.text().then(function responseSuccess(reponse) {
                    chainLog("success: " + message, reponse);
                }, function responseError(err) {
                    chainLog('response ok but failed: ' + message, err.error);
                });
            }

            chainLog('response not ok: ' + message, r.error);

        }, function failedToConnect(err) {
            chainLog('failed to connect: ' + message, err);
        });
    }

    doRequest("ts2 default", "https://api-dev.everymatrix.com/longpoll/open", true);

    doRequest("ajax to self", "/demo");

    doRequest("server-side ts2 fetch", "/server-side");

    doRequest("proxy", "/proxy/longpoll/open");

    doRequest("different domain (cats) ", "http://thecatapi.com/api/images/get?format=xml&results_per_page=1");
</script>
<noscript>noscript</noscript>

</body>
</html>