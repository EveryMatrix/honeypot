<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>fetching ts2</title>
    <script
            src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>
</head>
<body>
<h1>Fetching ts2 data</h1>
<pre id="response"></pre>
<h2>Log here:</h2>
<pre id="log"></pre>
<script>
    var logstr = [];

    function log(m, l) {
        logstr.push({message: m, log: l});
        document.getElementById("log").innerHTML = JSON.stringify(logstr, false, 4);

    }

    if (window) {
        window.addEventListener("error", function (e) {
            log("window error", {
                message: e.message,
                stack: e.error.stack,
                timestamp: parseInt(e.timeStamp, 10)
            });
        });
    }

    function sendLog(r) {
        log("sendLog", r);
        var body = JSON.stringify(r, false, 4);
        document.getElementById("response").innerHTML = body;
        jQuery.ajax({
            url: "/add-log",
            type: "POST",
            method: "POST",
            data: body,
            body: body,
            headers: {
                "content-type": "application/json"
            }
        });
    }

    function fetchData(url, cb, ecb) {
        jQuery.ajax({
                url: url,
                success: function (data) {
                    log("success ajax", {url: url, data: data});
                    cb(data);
                },
                error: function (request, status, error) {
                    log("error ajax", {url: url, request: request, status: status, error: error});
                    ecb({request: request, error: error, status: status});
                }

            }
        )
    }


    log("before ts ajax");
    fetchData("https://api-dev.everymatrix.com/longpoll/open", sendLog, sendLog);

    log("before self ajax");
    var selfCB = log.bind(null, "self ajax");
    fetchData("demo", selfCB, selfCB);

    log("before server-side ajax");
    var serverSideCB = log.bind(null, "server-side ajax");
    fetchData("/server-side", serverSideCB, serverSideCB);

    log("before proxy ajax");
    var proxyCB = log.bind(null, "proxy ajax");
    fetchData("/proxy/longpoll/open", proxyCB, proxyCB);

    log("before cats ajax");
    var catsCB = log.bind(null, "cats ajax (other domain)");
    fetchData("http://thecatapi.com/api/images/get?format=xml&results_per_page=1", catsCB, catsCB);


</script>
<noscript>no js run</noscript>

</body>
</html>